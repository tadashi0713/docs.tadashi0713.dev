---
title: Testcontainers Cloud ドキュメント
description: Testcontainers Cloudを使用してTestcontainersのテストを実行すると、すぐに利用できます。人気のある技術を使用してアプリケーションをテストするための同じTestcontainersモジュールにアクセスでき、ローカルマシンで重いコンテナを起動する必要がありません。
---

import Image from 'next/image'
import { Callout } from 'nextra/components'

# Testcontainers Cloud ドキュメント

## 概要

Testcontainers Cloud を使用して Testcontainers のテストを実行すると、すぐに利用できます。人気のある技術を使用してアプリケーションをテストするための同じ Testcontainers モジュールにアクセスでき、ローカルマシンで重いコンテナを起動する必要がありません。

## Testcontainers Cloud はどのように動作するのか？

Testcontainers Cloud エージェントは SSH トンネルを開き、クラウド環境内の Docker デーモンに接続します。

Testcontainers Cloud を使用することで、ローカル環境でコンテナを実行する必要がなくなります。ローカル環境でテストを実行すると、Testcontainers Cloud エージェントが SSH トンネルを開き、クラウド環境内の Docker デーモンに接続します。この際、Testcontainers を使用したテストで定義された Docker イメージをクラウド環境で取得し、コンテナを起動します。クラウド環境への接続はテスト実行中のみアクティブであり、テストスイートの完了後、Testcontainers Cloud は短時間待機した後、自動的に接続を閉じ、割り当てられたリソースを削除します。

![Testcontainers Desktopのクラウド接続図](/testcontainers-cloud-ja/tcd_cloud_diagram.png)

## はじめる

### クライアントをインストール

1. Testcontainers Desktopをダウンロードしてインストールします
2. `Run with Testcontainers Cloud` を選択します

<br />

<div align="center">
  <Image src="/testcontainers-cloud-ja/tcd-cloud-runtime.png" alt="Testcontainers Desktop のクラウドランタイム" width={400} height={1000}/>
</div>

Testcontainers Cloud 上で実行されるコンテナを使用して、Testcontainers ベースのテストを実行できるようになりました。

もし Testcontainers を使用した既存のテストがない場合は、Testcontainers Cloud があなたの環境で正しく設定されていることを確認するためのいくつかのテストを含むサンプルプロジェクトを利用することができます。

### サンプルプロジェクト

#### .NET

```shell
git clone https://github.com/AtomicJar/testcontainers-cloud-dotnet-example
cd testcontainers-cloud-dotnet-example
dotnet test --logger:"console;verbosity=detailed"
```

#### Go

```shell
git clone https://github.com/AtomicJar/testcontainers-cloud-go-example
cd testcontainers-cloud-go-example
go mod download
go test -v -count=1
```

#### Java

```shell
git clone https://github.com/AtomicJar/testcontainers-cloud-java-example
cd testcontainers-cloud-java-example
./mvnw test
```

#### Node.js

```shell
git clone https://github.com/AtomicJar/testcontainers-cloud-nodejs-example
cd testcontainers-cloud-nodejs-example
npm install
npm test
```

### 既存のテストの実行

Testcontainers ベースの統合テストは、Testcontainers Cloud を使用することでそのまま実行できます。Testcontainers Cloud の使用感をより良く理解するために、短時間で2回連続してテストを実行することをおすすめします。これにより、ウォームアップされた環境での動作を体験できます。

Testcontainers Cloud は、IDE からテストを実行する場合にも動作します。そのため、最初に IDE からいくつかのテストを実行して、プロジェクトのテストが Testcontainers Cloud でどのように動作するかを確認するのが便利です。通常の IDE の機能を使用してテストを実行し、Testcontainers Cloud が使用されている Docker 実装であることを確認するために出力ログをチェックしてください。

ローカルの Docker に切り替えたい場合は、Testcontainers Cloud クライアントアプリを停止するだけで、Testcontainers ベースの統合テストがローカル Docker を使用して実行されるようになります。

### 適切なコンテナランタイムの選択方法

システムが Docker daemon と Testcontainers Cloud の両方にアクセスできる場合、Testcontainers ライブラリは次の順序で使用する Docker 環境を決定します:

1. `~/.testcontainers.properties` ファイルを確認（存在する場合）:
    - `tc.host` プロパティからDockerデーモンの場所を取得。

2. 環境変数 `DOCKER_HOST` から Docker daemon の場所を取得。
3. 現在のオペレーティングシステムのデフォルトの Docker ロケーションを試す。

Testcontainers Cloud エージェント（Desktop と CI の両方）は、`~/.testcontainers.properties` ファイルに自分のロケーションを設定します。これにより、テストは自動的に Testcontainers Cloud を優先します。

### 特定のプロジェクトで無効化

Testcontainers Cloudを起動すると、デフォルトでローカル環境がTestcontainersのテストで使用されるように構成されます。ただし、特定のプロジェクトではこれを無効化したい場合があります。例えば、古いTestcontainersライブラリを使用しており、Testcontainers Cloudと互換性がない場合や、クラウドベースのコンテナ実行に適していないコードパターンを使用している場合です。

特定のプロジェクトでグローバルな Testcontainers Cloud 設定を使用しないようにするには、プロジェクト内（クラスパス上）の `testcontainers.properties` 設定ファイルで `dockerconfig.source` プロパティを更新します。

このオプションは Java 用 Testcontainers でのみ利用可能です。

以下の内容を含む `testcontainers.properties` 設定ファイルをプロジェクトのクラスパスに追加してください：

```
dockerconfig.source=autoIgnoringUserProperties
```

Testcontainers Cloud クライアントアプリを実行したままにしても問題ありませんが、それ以上の変更は必要ありません。このプロジェクトは、通常の自動 Testcontainers 環境検出メカニズムを使用して、Docker と通信するための適切な方法を見つけるようになります。

### Turbo モードでテストを並列化

Testcontainers Cloud の Turbo モードを使用すると、テストを並列実行できるようになります。各テストプロセスが独自のクラウド環境を受け取るため、テストの並列化がスケーラブルになります。テストを並列化することは、ビルドの実行速度を向上させる方法の1つです。

テストスイートの構成や利用可能なコンピューティングリソースによっては、ローカルリソースのボトルネックにより並列テストがパフォーマンス向上に繋がらない場合もあります。Testcontainers Cloud の Turbo モードでは、Testcontainers テストを実行する各プロセスに1つのクラウド環境が割り当てられるため、この問題を解決します。

これにより、同時にテストを実行するプロセス数を増やしても、ローカルコンピュートリソースの負荷が直線的に増加することはありません。クラウド環境のスケーラビリティによって、テストの実行速度を向上させることができます。

Turboモードは、大規模なテストスイートが許容範囲を超えて長時間実行される課題を抱えるユーザーにとって特に有益です。以下に、Testcontainers Cloud の Turbo モードを有効化してテストを並列実行する方法を説明します。

<Callout type="info">
  Turboモードは現在、Free アカウントでは制限されています。
</Callout>

#### デスクトップで Testcontainers Cloud の Turbo モードを開始する

Testcontainers Desktop アプリケーションで、Turbo モードを有効化するには、Turbo モードのチェックボックスを選択してください。

<br />

<div align="center">
  <Image src="/testcontainers-cloud-ja/tcd-turbo-mode.png" alt="Testcontainers Cloud の Turbo モード" width={400} height={1000}/>
</div>

#### CI で Turbo モードを有効化する方法

CI でエージェントを起動する際、`--max-concurrency=N` フラグを指定すると、このエージェントを使用するプロセスが利用できる最大 N 個の並列 Testcontainers Cloud 環境を有効化できます。

- `--max-concurrency` のデフォルト値は4です。
- 環境変数 `TC_CLOUD_CONCURRENCY` を使用して並列実行オプションを設定することもできます。例えば、以下のように設定します:

```bash
export TC_CLOUD_CONCURRENCY=2
```

これで、Testcontainers Cloud のスケーラビリティを利用して並列テストを実行する準備が整いました。並列テストを初めて行う場合、以下の一般的なビルドツールでの試し方をご覧ください。

#### Gradleを使用したJavaプロジェクトでのTurboモード有効化

Gradle でテストを並列実行するには、`build.gradle` ファイルのテストタスクに `maxParallelForks` を追加します：

```groovy
test.maxParallelForks = 4
```

これにより、Gradleは最大4つのプロセスを使用してテストを実行します。Turboモードが設定されている場合、各プロセスで作成されたコンテナは同じDocker環境をオーバーロードしません。

JavaプロジェクトでTurboモードを試してみたい場合は、GitHubリポジトリの手順に従ってサンプルプロジェクトを使用してみてください。

#### Mavenを使用したJavaプロジェクトでのTurboモード有効化

Maven をビルドツールとして使用している場合、テスト実行には Surefire プラグインを使用している可能性があります。Surefire プラグインは並列テスト実行をサポートしており、その有効化方法は公式ドキュメントを参照できます。

一般的に、Maven で並列テストを実行するには、`pom.xml` ファイルの Surefire または Failsafe プラグインの設定に `parallel` および `forkCount` プロパティを追加します。以下は、最新バージョンの Surefire プラグインのサンプル設定です：

```xml
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-surefire-plugin</artifactId>
  <version>3.0.0-M7</version>
  <configuration>
    <parallel>classes</parallel>
    <forkCount>4</forkCount>
  </configuration>
</plugin>
```

Java プロジェクトで Turbo モードを試したい場合は、GitHub リポジトリの手順に従ってサンプルプロジェクトを使用してみてください。

#### Turboモードが有効化されたかを確認する方法

Testcontainers Cloud で Turbo モードを有効化し、ビルドツールで並列テストを設定した場合、テストを実行すると Testcontainers Cloud アプリケーションの「connection」タブで複数のリース割り当てが表示されるはずです。

![Testcontainers DesktopでTurboモードが有効になっているか確認する](/testcontainers-cloud-ja/tcd-turbo-mode-connected.png)

#### Testcontainers Cloud がどのコンテナを同じクラウド環境で実行するかを決定する方法

Testcontainers Cloud ではセッションを使用してコンテナを区別します。同じプロセスであれば、例えば複数のコンテナを起動する必要がある場合でも、同じクラウド環境に接続します。

一方で、並列プロセスが実行される場合、現在実行中の Testcontainers Cloud エージェントの最大並列設定が許容する限り、新しいクラウド環境が割り当てられます。

したがって、Turbo モードを設定している場合でも、テストプロセスが1つしかない場合は、すべてのコンテナが同じクラウド環境で実行されます。たとえその1つのプロセス内でテストを並列実行していたとしても同様です。

複数のテストプロセス（例えばフォークされたJVM）を使用している場合、Turbo モードが有効になっていれば、可能な限り各JVMに専用のクラウド環境が割り当てられます。

### メモリ制限

各Testcontainers Cloudセッションには8GBのRAMが割り当てられます。この情報は接続が確立された際のログで確認できます:

```shell
Connected to docker: 
  Server Version: 70+testcontainerscloud
  API Version: 1.41
  Operating System: Ubuntu 22.04 LTS
  Total Memory: 7396 MB
```

現在、1つのTestcontainers Cloudセッションのメモリ使用量を拡張または制限することはできません。

### テストがクラウドで実行されているか確認する方法

Testcontainers Desktop アプリケーションの「Connection」セクションを確認します。

ローカルマシンに Testcontainers Cloud アプリケーションをインストールしている場合、トレイメニューにアプリアイコンが表示されます。テストが Testcontainers Cloud アプリケーションを使用して実行されていることを確認するには、Testcontainers Cloud アプリケーションのアイコンをクリックしてください。接続状態として「Running」または「Passive」が表示されます。「Connection」サブメニューをクリックすると、詳細な接続情報が確認できます。

- **Connected to**: 接続されているゾーン/リージョン（接続遅延がミリ秒単位で表示されます）

- **Leases**: 開かれたコネクションのID（状態)

`ACTIVE` Leases: コネクションがアクティブで、テストのための Testcontainers Cloud リソースが割り当てられている状態

`PASSIVE` Leases: コネクションが閉じられ、Testcontainers Cloud リソースが割り当てられていない状態

- **Data**: R: 読み取りデータ量（kB）, W: 書き込みデータ量（kB）

#### 実行中の状態（Running State）

![Testcontainers Desktop cloud connection status - active](/testcontainers-cloud-ja/tcd-cloud-connection-active.png)

#### パッシブ状態 (Passive State)

![Testcontainers Desktop cloud connection status - passive](/testcontainers-cloud-ja/tcd-cloud-connection-passive.png)

### システム再起動時にクライアントを自動起動

ユーザー体験を向上させるため、デスクトップアプリケーションのメニューに「Autostart」チェックボックスを追加しました。コンピュータを起動または再起動した際に Testcontainers Cloud を自動的に起動したい場合は、このチェックボックスを有効にしてください。この機能は、サポートされているすべてのオペレーティングシステムで同じように動作します。

<br />

<div align="center">
  <Image src="/testcontainers-cloud-ja/tcd-autostart.png" alt="Testcontainers Desktop autostart" width={400} height={1000}/>
</div>

## テストセッションにプロジェクトタグを付ける

Testcontainers Cloud を使用してテストを実行する際、[project](https://newsletter.testcontainers.com/announcements/tag-your-test-sessions-by-project) または [workflow](https://newsletter.testcontainers.com/announcements/link-your-test-sessions-to-your-ci-pipeline) の名前や URL を指定できます。この情報は Testcontainers Cloud のダッシュボードに表示され、実行中のテストやワークフローを簡単に特定することができます。

<br />

<div align="center">
  <Image src="/testcontainers-cloud-ja/tcc-project-and-workflow.png" alt="Testcontainers Desktop project and workflow" width={400} height={1000}/>
</div>

URL は任意で、指定を省略することも可能です。GitHub Actions を使用している場合、ワークフロー名と URL は自動的に検出され、Testcontainers Cloud ダッシュボードに表示されます。

### CIで環境変数を使用して設定

以下の環境変数を設定してください：

- プロジェクトの場合
    - `TCC_PROJECT_KEY` / `TCC_PROJECT_URL`
    - または、`~/.testcontainers.properties` ファイルで `tcc.project.key` と `tcc.project.url` プロパティを設定できます。
- ワークフローの場合
    - `TCC_WORKFLOW_KEY` / `TCC_WORKFLOW_URL`
    - または、`~/.testcontainers.properties` ファイルで `tcc.workflow.key` と `tcc.workflow.url` プロパティを設定できます。

### Testcontainers tests 内のラベルを使用して設定

- プロジェクト用
    - `cloud.testcontainers.tcc.project.key` / `cloud.testcontainers.tcc.project.url`
- ワークフロー用
    - `cloud.testcontainers.tcc.workflow.key` / `cloud.testcontainers.tcc.workflow.url`

