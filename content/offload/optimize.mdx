---
title: Docker Offload の利用を最適化する
description: Docker Offload の利用を最適化する方法について学びましょう。
---

# Docker Offload の利用を最適化する

Docker Offload は、ビルドをローカルで実行するのではなく、リモートで実行します。
つまり、ファイルはローカルシステムからクラウドへネットワーク経由で転送する必要があります。

ネットワーク経由でのファイル転送は、ローカル転送に比べて レイテンシが高く、帯域幅が低い という課題があります。
これを軽減するため、Docker Offload にはいくつかのパフォーマンス最適化が組み込まれています：

- ビルドキャッシュ用にアタッチドストレージボリュームを使用し、キャッシュの読み書きを高速化。

- ビルド結果をローカルマシンに戻す際は、前回のビルド以降に変更されたレイヤーのみを転送。

これらの最適化があっても、大規模なプロジェクトや低速なネットワーク接続では転送に時間がかかることがあります。
Docker Offload 用のビルド環境を最適化するための方法をいくつか紹介します：

- [`.dockerignore` ファイルを使用する](#dockerignore-ファイル)

- [スリムなベースイメージを選択する](#スリムなベースイメージ)

- [マルチステージビルドを使用する](#マルチステージビルド)

- [ビルド中にリモートファイルを取得する](#ビルド中にリモートファイルを取得する)

- [マルチスレッド対応ツールを活用する](#マルチスレッド対応ツール)

Dockerfile に関する一般的なヒントについては、[ビルドのベストプラクティス](https://docs.docker.com/build/building/best-practices/) を参照してください。

## dockerignore ファイル

[`.dockerignore ファイル`](https://docs.docker.com/build/concepts/context/#dockerignore-files) を使うと、ビルドコンテキストに含めないローカルファイルを指定できます。
このパターンで除外されたファイルは、ビルド時に Docker Offload へアップロードされません。

典型的に除外すべき項目の例：

- `.git` – バージョン履歴の転送を避ける（注意：ビルド内で `git` コマンドは利用できなくなります）。

- ビルド成果物やローカルで生成されたバイナリ。

- ビルドプロセス内で復元される依存フォルダ（例：`node_modules`）。

一般的な目安として、`.dockerignore` は `.gitignore` と同様の内容にすると良いでしょう。

## スリムなベースイメージ

`FROM` 命令でより小さいベースイメージを使用すると、最終的なイメージサイズを削減し、ビルドパフォーマンスを改善できます。
[`alpine`](https://hub.docker.com/_/alpine) イメージは最小限のベースイメージの好例です。

完全にスタティックなバイナリを利用する場合は、空のベースイメージである [`scratch`](https://hub.docker.com/_/scratch) を使用できます。

## マルチステージビルド

[マルチステージビルド](https://docs.docker.com/build/building/multi-stage/) を使うと、Dockerfile 内でビルド時の環境と実行時の環境を分離できます。
これにより、最終的なイメージサイズを削減できるだけでなく、ビルド中にステージを並列実行できるようになります。

`COPY --from` を使って、前のステージや外部イメージからファイルをコピーします。
この方法により、不要なレイヤーを最小化し、最終イメージのサイズを減らすことができます。

## ビルド中にリモートファイルを取得する

可能な場合、大きなファイルはローカルコンテキストに含めるのではなく、ビルド中にインターネットから直接ダウンロードしてください。
これにより、クライアントから Docker Offload へのネットワーク転送を回避できます。

これを行う方法の例：

- Dockerfile の [`ADD` 命令](https://docs.docker.com/reference/dockerfile/#add) を使用

- `wget`、`curl`、`rsync` などの `RUN` コマンドを使用

## マルチスレッド対応ツール

一部のビルドツール（例：`make`）はデフォルトでシングルスレッド実行になっています。
ツールが並列実行をサポートしている場合は、並列で動作するように設定してください。
例えば、`make --jobs=4` を使用すると、4 ジョブを同時に実行できます。

クラウド上で利用可能な CPU リソースを活用することで、ビルド時間を大幅に短縮できます。
