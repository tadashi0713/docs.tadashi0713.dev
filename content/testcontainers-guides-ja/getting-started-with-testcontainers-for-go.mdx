---
title: Go ã§ Testcontainers ã‚’ä½¿ã„å§‹ã‚ã‚‹
description: ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€PostgreSQL ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚’ä¾‹ã«ã€Go ã§ Testcontainers ã‚’ä½¿ã„å§‹ã‚ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚
---

import { Callout, Cards } from 'nextra/components'
import { FaGithub } from "react-icons/fa"

# Go ã§ Testcontainers ã‚’ä½¿ã„å§‹ã‚ã‚‹

<br />
<br />

<Cards.Card
  icon={<FaGithub />}
  title="ã‚³ãƒ¼ãƒ‰ã‚’å…¥æ‰‹ã™ã‚‹"
  href="https://github.com/testcontainers/tc-guide-getting-started-with-testcontainers-for-go"
/>

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’å­¦ã³ã¾ã™ï¼š

- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ Go ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã€‚

- pgx ãƒ‰ãƒ©ã‚¤ãƒã‚’ä½¿ç”¨ã—ã¦ã€PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã€‚

- testcontainers-go ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã€‚

## å‰ææ¡ä»¶

- Go 1.19 ä»¥ä¸Š

- ãŠå¥½ã¿ã® IDEï¼ˆVS Code ã‚„ GoLand ãªã©ï¼‰

- Testcontainers ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹ Docker ç’°å¢ƒ
  https://golang.testcontainers.org/system_requirements/


## ã“ã®ã‚¬ã‚¤ãƒ‰ã§é”æˆã™ã‚‹ã“ã¨

Go ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦é¡§å®¢æƒ…å ±ã‚’ä¿å­˜ãŠã‚ˆã³å–å¾—ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’å®Ÿè£…ã—ã¾ã™ã€‚ãã®å¾Œã€testcontainers-go ã® PostgreSQL ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

Go ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```bash
$ mkdir testcontainers-go-demo
$ cd testcontainers-go-demo
$ go mod init github.com/testcontainers/testcontainers-go-demo
```

PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨å¯¾è©±ã™ã‚‹ãŸã‚ã« [jackc/pgx](https://github.com/jackc/pgx) ãƒ‰ãƒ©ã‚¤ãƒã‚’ä½¿ç”¨ã—ã€ãƒ†ã‚¹ãƒˆç”¨ã« **testcontainers-go** [postgres module](https://golang.testcontainers.org/modules/postgres/) ã‚’åˆ©ç”¨ã—ã¦ PostgreSQL Docker ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ã€‚ã¾ãŸã€è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ããŸã‚ã« [testify](https://github.com/stretchr/testify) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

<Callout type="info">
  Testcontainers ã‚’åˆã‚ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€[Testcontainers ã¨ã¯ä½•ã‹ã€ãªãœä½¿ã†ã¹ããªã®ã‹ï¼Ÿ](/testcontainers-guides-ja/introducing-testcontainers)ã‚’èª­ã‚“ã§ã€Testcontainersã«ã¤ã„ã¦è©³ã—ãå­¦ã‚“ã§ãã ã•ã„ã€‚
</Callout>

ã“ã‚Œã‚‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ go get github.com/jackc/pgx/v5
$ go get github.com/testcontainers/testcontainers-go
$ go get github.com/testcontainers/testcontainers-go/modules/postgres
$ go get github.com/stretchr/testify
```

ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã€`go.mod` ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```go
module github.com/testcontainers/testcontainers-go-demo

go 1.19

require (
   github.com/jackc/pgx/v5 v5.3.1
   github.com/stretchr/testify v1.8.3
   github.com/testcontainers/testcontainers-go v0.20.1
   github.com/testcontainers/testcontainers-go/modules/postgres v0.20.1
)

require (
   // indirect dependencies here
)
```

## Customer struct ã®ä½œæˆ

ã¾ãšã€`customer` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã« `types.go` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€é¡§å®¢æƒ…å ±ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ Customer struct ã‚’å®šç¾©ã—ã¾ã™:

```go
package customer

type Customer struct {
	Id    int
	Name  string
	Email string
}
```

## Repository ã®ä½œæˆ

æ¬¡ã«ã€`customer/repo.go` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`Repository` struct ã‚’å®šç¾©ã—ã¦ã€æ–°ã—ã„é¡§å®¢ã‚’ä½œæˆãŠã‚ˆã³ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```go
package customer

import (
	"context"
	"fmt"
	"os"

	"github.com/jackc/pgx/v5"
)

type Repository struct {
	conn *pgx.Conn
}

func NewRepository(ctx context.Context, connStr string) (*Repository, error) {
	conn, err := pgx.Connect(ctx, connStr)
	if err != nil {
		_, _ = fmt.Fprintf(os.Stderr, "Unable to connect to database: %v\n", err)
		return nil, err
	}
	return &Repository{
		conn: conn,
	}, nil
}

func (r Repository) CreateCustomer(ctx context.Context, customer Customer) (Customer, error) {
	err := r.conn.QueryRow(ctx,
		"INSERT INTO customers (name, email) VALUES ($1, $2) RETURNING id",
		customer.Name, customer.Email).Scan(&customer.Id)
	return customer, err
}

func (r Repository) GetCustomerByEmail(ctx context.Context, email string) (Customer, error) {
	var customer Customer
	query := "SELECT id, name, email FROM customers WHERE email = $1"
	err := r.conn.QueryRow(ctx, query, email).
		Scan(&customer.Id, &customer.Name, &customer.Email)
	if err != nil {
		return Customer{}, err
	}
	return customer, nil
}
```

ã“ã“ã§ã®å‡¦ç†å†…å®¹ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†:

- `Repository` struct ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’è¡Œã†ãŸã‚ã® `*pgx.Conn` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€`Repository` ã‚’åˆæœŸåŒ–ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° `NewRepository` ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚

- `CreateCustomer()` ã¨ `GetCustomerByEmail()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ `Repository` ã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã¨ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚

## testcontainers-go ã‚’ä½¿ç”¨ã—ãŸ Repository ã®ãƒ†ã‚¹ãƒˆ

`Repository` ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚**testcontainers-go** ã‚’ä½¿ç”¨ã—ã¦ Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•ã—ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

`testdata/init-db.sql` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`CUSTOMERS` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ã¾ã™:

```sql
CREATE TABLE IF NOT EXISTS customers (id serial, name varchar(255), email varchar(255));

INSERT INTO customers(name, email) VALUES ('John', 'john@gmail.com');
```

**testcontainers-go** ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€ä»»æ„ã®ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®æ±ç”¨çš„ãª **Container** æŠ½è±¡åŒ–ã‚’æä¾›ã—ã¾ã™ã€‚ã•ã‚‰ã«ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«ã€testcontainers-go ã¯æŠ€è¡“å›ºæœ‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æä¾›ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å‰Šæ¸›ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç°¡å˜ã«æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚æä¾›ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€PostgresContainer ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€Postgres ã‚³ãƒ³ãƒ†ãƒŠã®ã•ã¾ã–ã¾ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç°¡å˜ã«è¨­å®šã§ãã¾ã™ï¼š

- `WithImage()`
- `WithDatabase()`
- `WithUsername()`
- `WithPassword()`

ãã‚Œã§ã¯ã€`customer/repo_test.go` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```go
package customer

import (
	"context"
	"path/filepath"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/testcontainers/testcontainers-go"
	"github.com/testcontainers/testcontainers-go/modules/postgres"
	"github.com/testcontainers/testcontainers-go/wait"
)

func TestCustomerRepository(t *testing.T) {
	ctx := context.Background()

	pgContainer, err := postgres.RunContainer(ctx,
		testcontainers.WithImage("postgres:15.3-alpine"),
		postgres.WithInitScripts(filepath.Join("..", "testdata", "init-db.sql")),
		postgres.WithDatabase("test-db"),
		postgres.WithUsername("postgres"),
		postgres.WithPassword("postgres"),
		testcontainers.WithWaitStrategy(
			wait.ForLog("database system is ready to accept connections").
				WithOccurrence(2).WithStartupTimeout(5*time.Second)),
	)
	if err != nil {
		t.Fatal(err)
	}

	t.Cleanup(func() {
		if err := pgContainer.Terminate(ctx); err != nil {
			t.Fatalf("failed to terminate pgContainer: %s", err)
		}
	})

	connStr, err := pgContainer.ConnectionString(ctx, "sslmode=disable")
	assert.NoError(t, err)

	customerRepo, err := NewRepository(ctx, connStr)
	assert.NoError(t, err)

	c, err := customerRepo.CreateCustomer(ctx, Customer{
		Name:  "Henry",
		Email: "henry@gmail.com",
	})
	assert.NoError(t, err)
	assert.NotNil(t, c)

	customer, err := customerRepo.GetCustomerByEmail(ctx, "henry@gmail.com")
	assert.NoError(t, err)
	assert.NotNil(t, customer)
	assert.Equal(t, "Henry", customer.Name)
	assert.Equal(t, "henry@gmail.com", customer.Email)
}
```

ã“ã“ã§ã®å‡¦ç†å†…å®¹ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†ï¼š

- Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ `postgres:15.3-alpine` ã‚’æŒ‡å®šã—ã¦ `PostgresContainer` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åŸºã«ã‚³ãƒ³ãƒ†ãƒŠãŒä½œæˆã•ã‚Œã¾ã™ã€‚

- `WithInitScripts(â€¦)` ã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èµ·å‹•å¾Œã« `CUSTOMERS` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

- Postgres ã‚³ãƒ³ãƒ†ãƒŠç”¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

- `WaitStrategy` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€Postgres ã‚³ãƒ³ãƒ†ãƒŠãŒå®Œå…¨ã«åˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

- `t.Cleanup(â€¦)` ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã« Postgres ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

- `PostgresContainer` ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—ã—ã€`Repository` ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒ `henry@gmail.com` ã®é¡§å®¢ã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã« `henry@gmail.com` ã®é¡§å®¢ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚

## è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã§ã‚³ãƒ³ãƒ†ãƒŠã‚’å†åˆ©ç”¨ã™ã‚‹

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€1ã¤ã®ãƒ†ã‚¹ãƒˆã®ãŸã‚ã« Postgres ã® Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€é€šå¸¸ã€1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€ãã‚Œã‚‰ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§åŒã˜ Postgres Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’å†åˆ©ç”¨ã—ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªå ´åˆã€å…±é€šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ãƒ†ã‚¢ãƒ€ã‚¦ãƒ³ï¼ˆå¾Œå‡¦ç†ï¼‰ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã« [testify suite](https://pkg.go.dev/github.com/stretchr/testify/suite) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

ã¾ãšã€`PostgresContainer` ã®ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ« `testhelpers/containers.go` ã«æŠ½å‡ºã—ã¾ã—ã‚‡ã†ã€‚

```go
package testhelpers

import (
	"context"
	"path/filepath"
	"time"

	"github.com/testcontainers/testcontainers-go"
	"github.com/testcontainers/testcontainers-go/modules/postgres"
	"github.com/testcontainers/testcontainers-go/wait"
)

type PostgresContainer struct {
	*postgres.PostgresContainer
	ConnectionString string
}

func CreatePostgresContainer(ctx context.Context) (*PostgresContainer, error) {
	pgContainer, err := postgres.RunContainer(ctx,
		testcontainers.WithImage("postgres:15.3-alpine"),
		postgres.WithInitScripts(filepath.Join("..", "testdata", "init-db.sql")),
		postgres.WithDatabase("test-db"),
		postgres.WithUsername("postgres"),
		postgres.WithPassword("postgres"),
		testcontainers.WithWaitStrategy(
			wait.ForLog("database system is ready to accept connections").
				WithOccurrence(2).WithStartupTimeout(5*time.Second)),
	)
	if err != nil {
		return nil, err
	}
	connStr, err := pgContainer.ConnectionString(ctx, "sslmode=disable")
	if err != nil {
		return nil, err
	}

	return &PostgresContainer{
		PostgresContainer: pgContainer,
		ConnectionString:  connStr,
	}, nil
}
```

`containers.go` ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€testcontainers-go ã® `PostgresContainer` struct ã‚’æ‹¡å¼µã—ãŸç‹¬è‡ªã® `PostgresContainer` struct ã‚’å®šç¾©ã—ã€ç°¡å˜ã«æ¥ç¶šæ–‡å­—åˆ— (`ConnectionString`) ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã¾ãŸã€`PostgresContainer` ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ãŸã‚ã® `CreatePostgresContainer()` é–¢æ•°ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

æ¬¡ã«ã€`customer/repo_suite_test.go` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€testify suite ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€æ–°ã—ã„é¡§å®¢ã‚’ä½œæˆã™ã‚‹ãƒ†ã‚¹ãƒˆã¨ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§é¡§å®¢ã‚’å–å¾—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€‚

```go
package customer

import (
	"context"
	"log"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/suite"
	"github.com/testcontainers/testcontainers-go-demo/testhelpers"
)

type CustomerRepoTestSuite struct {
	suite.Suite
	pgContainer *testhelpers.PostgresContainer
	repository  *Repository
	ctx         context.Context
}

func (suite *CustomerRepoTestSuite) SetupSuite() {
	suite.ctx = context.Background()
	pgContainer, err := testhelpers.CreatePostgresContainer(suite.ctx)
	if err != nil {
		log.Fatal(err)
	}
	suite.pgContainer = pgContainer
	repository, err := NewRepository(suite.ctx, suite.pgContainer.ConnectionString)
	if err != nil {
		log.Fatal(err)
	}
	suite.repository = repository
}

func (suite *CustomerRepoTestSuite) TearDownSuite() {
	if err := suite.pgContainer.Terminate(suite.ctx); err != nil {
		log.Fatalf("error terminating postgres container: %s", err)
	}
}

func (suite *CustomerRepoTestSuite) TestCreateCustomer() {
	t := suite.T()

	customer, err := suite.repository.CreateCustomer(suite.ctx, Customer{
		Name:  "Henry",
		Email: "henry@gmail.com",
	})
	assert.NoError(t, err)
	assert.NotNil(t, customer.Id)
}

func (suite *CustomerRepoTestSuite) TestGetCustomerByEmail() {
	t := suite.T()

	customer, err := suite.repository.GetCustomerByEmail(suite.ctx, "john@gmail.com")
	assert.NoError(t, err)
	assert.NotNil(t, customer)
	assert.Equal(t, "John", customer.Name)
	assert.Equal(t, "john@gmail.com", customer.Email)
}

func TestCustomerRepoTestSuite(t *testing.T) {
	suite.Run(t, new(CustomerRepoTestSuite))
}
```

ã“ã“ã§ã®å‡¦ç†å†…å®¹ã‚’ç†è§£ã—ã¾ã—ã‚‡ã†:

- `CustomerRepoTestSuite` ã®ä½œæˆ

  `suite.Suite` struct ã‚’æ‹¡å¼µã—ã¦ `CustomerRepoTestSuite` ã‚’ä½œæˆã—ã€ã“ã®ã‚¹ã‚¤ãƒ¼ãƒˆå†…ã®è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

- `SetupSuite()` é–¢æ•°

  ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚ã“ã®ä¸­ã§ `PostgresContainer` ã‚’ä½œæˆã—ã€`Repository` ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

- `TearDownSuite()` é–¢æ•°

  ã‚¹ã‚¤ãƒ¼ãƒˆå†…ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒçµ‚äº†ã—ãŸå¾Œã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚ã“ã®ä¸­ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’çµ‚äº†ã—ã€Postgres Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¾ã™ã€‚

- ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ä½œæˆ

  `TestCreateCustomer()` ã¨ `TestGetCustomerByEmail()` ã‚’ã‚¹ã‚¤ãƒ¼ãƒˆã®ãƒ¬ã‚·ãƒ¼ãƒé–¢æ•°ã¨ã—ã¦ä½œæˆã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã§é¡§å®¢ã®ä½œæˆã¨å–å¾—ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

- ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Ÿè¡Œ

  `TestCustomerRepoTestSuite(t *testing.T)` é–¢æ•°ã‚’ä½œæˆã—ã€`go test` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸéš›ã«ã“ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

<Callout>
  ã“ã®ã‚¬ã‚¤ãƒ‰ã®ç›®çš„ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ—¢çŸ¥ã®çŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã¯ã€è‰¯ã„ç¿’æ…£ã§ã™ã€‚
</Callout>

## ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã¯ `go test ./...` ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ã€è©³ç´°ãªå‡ºåŠ›ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚° `-v` ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```bash
$ go test -v ./...

=== RUN   TestCustomerRepoTestSuite
...
...
2023/06/13 09:27:11 ğŸ³ Creating container for image docker.io/testcontainers/ryuk:0.4.0
2023/06/13 09:27:11 âœ… Container created: 2881f4e311a2
2023/06/13 09:27:11 ğŸ³ Starting container: 2881f4e311a2
2023/06/13 09:27:12 ğŸš§ Waiting for container id 2881f4e311a2 image: docker.io/testcontainers/ryuk:0.4.0
2023/06/13 09:27:12 âœ… Container started: 2881f4e311a2
2023/06/13 09:27:12 ğŸ³ Creating container for image postgres:15.3-alpine
2023/06/13 09:27:12 âœ… Container created: a98029633d02
2023/06/13 09:27:12 ğŸ³ Starting container: a98029633d02
2023/06/13 09:27:13 ğŸš§ Waiting for container id a98029633d02 image: postgres:15.3-alpine
2023/06/13 09:27:14 âœ… Container started: a98029633d02
=== RUN   TestCustomerRepoTestSuite/TestCreateCustomer
=== RUN   TestCustomerRepoTestSuite/TestGetCustomerByEmail
2023/06/13 09:27:14 ğŸ³ Terminating container: a98029633d02
2023/06/13 09:27:15 ğŸš« Container terminated: a98029633d02
--- PASS: TestCustomerRepoTestSuite (3.66s)
    --- PASS: TestCustomerRepoTestSuite/TestCreateCustomer (0.00s)
    --- PASS: TestCustomerRepoTestSuite/TestGetCustomerByEmail (0.00s)
=== RUN   TestCustomerRepository
2023/06/13 09:27:15 ğŸ³ Creating container for image postgres:15.3-alpine
2023/06/13 09:27:15 âœ… Container created: fcf4241a61ab
2023/06/13 09:27:15 ğŸ³ Starting container: fcf4241a61ab
2023/06/13 09:27:15 ğŸš§ Waiting for container id fcf4241a61ab image: postgres:15.3-alpine
2023/06/13 09:27:16 âœ… Container started: fcf4241a61ab
2023/06/13 09:27:16 ğŸ³ Terminating container: fcf4241a61ab
2023/06/13 09:27:17 ğŸš« Container terminated: fcf4241a61ab
--- PASS: TestCustomerRepository (1.94s)
PASS
ok  	github.com/testcontainers/testcontainers-go-demo/customer	6.177s
?   	github.com/testcontainers/testcontainers-go-demo/testhelpers	[no test files]
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€2ã¤ã® Postgres Docker ã‚³ãƒ³ãƒ†ãƒŠãŒè‡ªå‹•çš„ã«èµ·å‹•ã•ã‚Œã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ï¼š1ã¤ã¯ã‚¹ã‚¤ãƒ¼ãƒˆã¨ãã®2ã¤ã®ãƒ†ã‚¹ãƒˆç”¨ã€ã‚‚ã†1ã¤ã¯æœ€åˆã«ä½œæˆã—ãŸå˜ä¸€ã®ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚ã“ã‚Œã‚‰ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã¯æ­£å¸¸ã«ãƒ‘ã‚¹ã™ã‚‹ã¯ãšã§ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œå¾Œã«ã‚³ãƒ³ãƒ†ãƒŠãŒåœæ­¢ã—ã€è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

## ã¾ã¨ã‚

Testcontainers for Go ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€æœ¬ç•ªç’°å¢ƒã¨åŒã˜ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgresï¼‰ã‚’ä½¿ç”¨ã—ãŸçµ±åˆãƒ†ã‚¹ãƒˆã‚’ä½œæˆã§ãã¾ã—ãŸã€‚ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã›ãšã€å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨å¯¾è©±ã™ã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è‡ªç”±ã«è¡Œã„ã¤ã¤ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚

Testcontainers ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€https://testcontainers.com ã‚’ã”è¦§ãã ã•ã„ã€‚

## å‚è€ƒè³‡æ–™

- https://golang.testcontainers.org/

- https://golang.testcontainers.org/quickstart/

- https://golang.testcontainers.org/modules/postgres/

- https://testcontainers.com/modules/
